<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Help - Intelligent Travel Recommendations</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #1a202c;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        header {
            padding: 48px 0 32px 0;
            margin-bottom: 48px;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 12px;
            font-weight: 800;
            color: #1a202c;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #718096;
            line-height: 1.6;
            font-weight: 400;
        }

        .controls {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        button {
            background: #1a202c;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        button:hover {
            background: #2d3748;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            color: #666;
            font-size: 0.95rem;
        }

        .status.loading {
            color: #4299e1;
            font-weight: 600;
        }

        .status.error {
            color: #e53e3e;
            font-weight: 600;
        }

        .status.success {
            color: #38a169;
            font-weight: 600;
        }

        .destinations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .destination-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .destination-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
            border-color: #cbd5e0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .city-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .country {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 4px;
        }

        .iata-code {
            background: #1a202c;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .weather-section {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .weather-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .temperature {
            font-size: 2rem;
            font-weight: 700;
            color: #4299e1;
        }

        .weather-description {
            color: #4a5568;
            font-size: 0.95rem;
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #718096;
        }

        .qol-section {
            margin-top: 16px;
        }

        .qol-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
        }

        .qol-grid {
            display: grid;
            gap: 8px;
        }

        .qol-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #718096;
            padding: 6px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .qol-item:last-child {
            border-bottom: none;
        }

        .qol-value {
            font-weight: 600;
            color: #2d3748;
        }

        .no-weather {
            color: #e53e3e;
            font-size: 0.9rem;
            font-style: italic;
            text-align: center;
            padding: 12px;
        }

        .api-info {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #4a5568;
            border-left: 4px solid #4299e1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .api-endpoint {
            font-family: monospace;
            background: #f7fafc;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            word-break: break-all;
            font-size: 0.85rem;
        }

        .airport-resolver {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 48px;
        }

        .airport-resolver h2 {
            font-size: 2rem;
            margin-bottom: 16px;
            color: #1a202c;
            font-weight: 700;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
        }

        .airport-result {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        .airport-result.show {
            display: block;
        }

        .airport-code {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .airport-name {
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .airport-location {
            font-size: 0.9rem;
            color: #718096;
        }

        .recommendations-section {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 48px;
            display: none;
        }

        .recommendations-section.show {
            display: block;
        }

        .recommendations-section h2 {
            color: #1a202c;
            margin-bottom: 16px;
            font-size: 2rem;
            font-weight: 700;
        }

        .recommendations-note {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 16px;
            margin: 20px 0;
            font-size: 0.9rem;
            color: #856404;
            border-radius: 8px;
        }

        .weight-controls {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }

        .weight-controls h3 {
            margin-bottom: 12px;
            font-size: 1.2rem;
            color: #1a202c;
            font-weight: 700;
        }

        .weight-controls input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .weight-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a202c;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .weight-controls input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 8px rgba(26, 32, 44, 0.1);
        }

        .weight-controls input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a202c;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .weight-controls input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 8px rgba(26, 32, 44, 0.1);
        }

        #getRecommendationsBtn {
            margin-bottom: 32px;
            margin-top: 8px;
        }

        .recommendation-card {
            background: white;
            color: #1a202c;
            padding: 32px;
            border-radius: 16px;
            margin: 24px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 2px solid #e2e8f0;
            position: relative;
            transition: all 0.2s ease;
        }

        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
            border-color: #cbd5e0;
        }

        .recommendation-rank {
            position: absolute;
            top: -12px;
            right: 24px;
            background: #1a202c;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.3rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .recommendation-city {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1a202c;
        }

        .recommendation-country {
            font-size: 1rem;
            color: #718096;
        }

        .recommendation-score {
            text-align: right;
        }

        .score-total {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
        }

        .score-label {
            font-size: 0.85rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .score-item {
            text-align: center;
        }

        .score-item-label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .score-item-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
        }

        .recommendation-details {
            display: flex;
            justify-content: space-around;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #e2e8f0;
        }

        .detail-item {
            text-align: center;
        }

        .detail-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: #1a202c;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(66, 153, 225, 0.2);
            border-left-color: #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .map-container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 48px;
        }

        .map-container h2 {
            color: #1a202c;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 200px;
        }

        .map-popup {
            padding: 16px;
        }

        .map-popup-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .map-popup-details {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
        }

        .map-popup-score {
            background: #1a202c;
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            #map {
                height: 400px;
            }
            .input-group {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Travel Help</h1>
                <p class="subtitle">Intelligent travel recommendations powered by cloud computing</p>
            </div>
        </header>

        <div class="map-container">
            <h2>Interactive Travel Map</h2>
            <div id="map"></div>
        </div>

        <div class="api-info">
            <strong>API Status:</strong> Connected to AWS Lambda via API Gateway<br>
            <div class="api-endpoint" id="apiEndpoint"></div>
        </div>

        <div class="airport-resolver">
            <h2>Find Your Nearest Airport</h2>
            <div class="input-group">
                <input type="text" id="cityInput" placeholder="Enter your city (e.g., Toledo)" />
                <input type="text" id="countryInput" placeholder="Enter your country (e.g., Spain)" />
                <button onclick="resolveAirport()">Find Airport</button>
            </div>
            <div class="airport-result" id="airportResult">
                <div class="airport-code" id="airportCode"></div>
                <div class="airport-name" id="airportName"></div>
                <div class="airport-location" id="airportLocation"></div>
            </div>
        </div>

        <div class="recommendations-section" id="recommendationsSection">
            <h2>Your Personalized Travel Recommendations</h2>
            <p style="color: #666; margin-bottom: 15px;">Get the top 3 destinations ranked by weather, quality of life, and flight prices from your airport.</p>

            <div class="recommendations-note">
                <strong>Note:</strong> Calculating recommendations takes 10-15 seconds as we search real-time flight prices for all 12 destinations in parallel.
            </div>

            <!-- Weight Adjustment Controls -->
            <div class="weight-controls">
                <h3>Customize Your Preferences</h3>
                <p style="color: #718096; font-size: 0.9rem; margin-bottom: 20px;">Adjust the importance of each factor (must total 100%)</p>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2d3748; font-weight: 600;">
                        <span>üå§Ô∏è Weather</span>
                        <strong id="weatherWeightValue" style="color: #1a202c;">30%</strong>
                    </label>
                    <input type="range" id="weatherWeight" min="0" max="100" value="30" step="5" oninput="updateWeights('weather')">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2d3748; font-weight: 600;">
                        <span>üèôÔ∏è Quality of Life</span>
                        <strong id="qolWeightValue" style="color: #1a202c;">30%</strong>
                    </label>
                    <input type="range" id="qolWeight" min="0" max="100" value="30" step="5" oninput="updateWeights('qol')">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2d3748; font-weight: 600;">
                        <span>‚úàÔ∏è Flight Price</span>
                        <strong id="flightWeightValue" style="color: #1a202c;">40%</strong>
                    </label>
                    <input type="range" id="flightWeight" min="0" max="100" value="40" step="5" oninput="updateWeights('flight')">
                </div>

                <div id="weightWarning" style="color: #e53e3e; font-size: 0.9rem; display: none; margin-top: 16px; font-weight: 600;">
                    ‚ö†Ô∏è Weights must total 100%
                </div>
            </div>

            <button id="getRecommendationsBtn" onclick="getRecommendations()">
                Get My Top 3 Recommendations
            </button>

            <div id="recommendationsContent"></div>
        </div>

        <div class="controls">
            <div class="status" id="status">Click "Fetch Weather Data" to load destinations</div>
            <button id="fetchBtn" onclick="fetchDestinations()">Fetch Weather Data</button>
        </div>

        <div class="destinations-grid" id="destinationsGrid"></div>
    </div>

    <script>
        // API Gateway endpoint
        const API_ENDPOINT = 'https://e4ml7tmfog.execute-api.eu-west-1.amazonaws.com';

        // Authentication token (read from localStorage - shared with parent page)
        let authToken = null;
        let tokenReady = false;

        // Function to get valid token
        function getAuthToken() {
            if (!authToken) {
                authToken = localStorage.getItem('idToken');
            }
            return authToken;
        }

        // Wait for token to be available
        function waitForToken() {
            return new Promise((resolve, reject) => {
                // Check immediately
                authToken = localStorage.getItem('idToken');
                if (authToken) {
                    console.log('Auth token found immediately');
                    tokenReady = true;
                    resolve(authToken);
                    return;
                }

                // Listen for token from parent
                const messageHandler = (event) => {
                    if (event.data && event.data.type === 'AUTH_TOKEN') {
                        authToken = event.data.token;
                        localStorage.setItem('idToken', authToken);
                        console.log('Auth token received via postMessage:', authToken ? 'YES' : 'NO');
                        tokenReady = true;
                        window.removeEventListener('message', messageHandler);
                        resolve(authToken);
                    }
                };
                window.addEventListener('message', messageHandler);

                // Poll localStorage
                let attempts = 0;
                const checkToken = setInterval(() => {
                    attempts++;
                    const token = localStorage.getItem('idToken');
                    if (token) {
                        authToken = token;
                        console.log('Auth token found in localStorage after', attempts, 'attempts');
                        tokenReady = true;
                        clearInterval(checkToken);
                        window.removeEventListener('message', messageHandler);
                        resolve(authToken);
                    } else if (attempts > 50) { // 5 seconds
                        clearInterval(checkToken);
                        window.removeEventListener('message', messageHandler);
                        reject(new Error('Auth token not found after 5 seconds'));
                    }
                }, 100);
            });
        }

        // Initialize token on page load
        waitForToken().catch(err => {
            console.error('Failed to get auth token:', err);
            alert('Authentication error. Please log out and log back in.');
        });

        // Display API endpoint
        document.getElementById('apiEndpoint').textContent = API_ENDPOINT + '/weather';

        // Store user's departure airport
        let userDepartureAirport = null;
        let userDepartureCoords = null;
        let userAirportAlternatives = [];

        // ===================================
        // MAP INITIALIZATION
        // ===================================
        let map = null;
        let departureMarker = null;
        let destinationMarkers = [];
        let flightPaths = [];

        // Initialize map on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Create map centered on Europe
            map = L.map('map').setView([50.0, 10.0], 4);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        });

        // Create custom colored icon
        function createCustomIcon(color, emoji) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${color};
                    width: 40px;
                    height: 40px;
                    border-radius: 50% 50% 50% 0;
                    transform: rotate(-45deg);
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <span style="transform: rotate(45deg); font-size: 20px;">${emoji}</span>
                </div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // Add departure marker
        function addDepartureMarker(lat, lon, airportCode, airportName, city, country) {
            console.log('addDepartureMarker called:', { lat, lon, airportCode, city, country });
            console.log('Current departureMarker:', departureMarker);

            // Step 1: Remove old home marker if exists
            if (departureMarker !== null && departureMarker !== undefined) {
                console.log('Removing old departure marker');
                map.removeLayer(departureMarker);
                departureMarker = null;
            }

            // Step 2: Create new home marker
            console.log('Creating new departure marker at', [lat, lon]);
            departureMarker = L.marker([lat, lon], {
                icon: createCustomIcon('#4299e1', 'üè†')
            });

            // Step 3: Add popup
            departureMarker.bindPopup(`
                <div class="map-popup">
                    <div class="map-popup-title">Your Departure</div>
                    <div class="map-popup-details">
                        <strong>${city}, ${country}</strong><br>
                        ${airportCode} - ${airportName}
                    </div>
                </div>
            `);

            // Step 4: Add to map
            departureMarker.addTo(map);
            console.log('New departure marker added to map');

            // Step 5: Store coordinates
            userDepartureCoords = [lat, lon];

            // Step 6: Zoom to location
            map.setView([lat, lon], 6, { animate: true });
        }

        // Add recommendation markers and flight paths
        function addRecommendationMarkers(recommendations) {
            // Clear existing destination markers and paths
            destinationMarkers.forEach(marker => map.removeLayer(marker));
            flightPaths.forEach(path => map.removeLayer(path));
            destinationMarkers = [];
            flightPaths = [];

            if (!userDepartureCoords) {
                console.warn('No departure coordinates set');
                return;
            }

            // Marker colors and emojis
            const markerStyles = [
                { color: '#ffc107', emoji: 'ü•á' }, // Gold
                { color: '#c0c0c0', emoji: 'ü•à' }, // Silver
                { color: '#cd7f32', emoji: 'ü•â' }  // Bronze
            ];

            const bounds = [userDepartureCoords];

            recommendations.forEach((rec, index) => {
                // Use coordinates from API response (not hardcoded lookup!)
                if (!rec.latitude || !rec.longitude) {
                    console.warn(`No coordinates for ${rec.city}, skipping marker`);
                    return;
                }
                const coords = [rec.latitude, rec.longitude];

                bounds.push(coords);

                // Create marker
                const marker = L.marker(coords, {
                    icon: createCustomIcon(markerStyles[index].color, markerStyles[index].emoji)
                }).addTo(map);

                // Create popup
                marker.bindPopup(`
                    <div class="map-popup">
                        <div class="map-popup-title">#${index + 1} ${rec.city}</div>
                        <div class="map-popup-details">
                            <strong>${rec.country}</strong> (${rec.iata_code})<br>
                            üå°Ô∏è ${rec.details.avg_temperature}¬∞C<br>
                            ‚úàÔ∏è ${rec.details.flight_price ? '‚Ç¨' + rec.details.flight_price.toFixed(2) : 'N/A'}<br>
                            üçΩÔ∏è ${rec.details.quality_of_life.michelin_restaurants} Michelin ‚≠ê
                        </div>
                        <div class="map-popup-score">Score: ${rec.scores.total_score.toFixed(3)}</div>
                    </div>
                `);

                destinationMarkers.push(marker);

                // Draw flight path (curved line using polyline)
                const flightPath = L.polyline([userDepartureCoords, coords], {
                    color: markerStyles[index].color,
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);

                flightPaths.push(flightPath);
            });

            // Auto-zoom to fit all markers
            if (bounds.length > 1) {
                map.fitBounds(bounds, { padding: [50, 50], animate: true });
            }
        }

        // Get destination coordinates (from hardcoded data)
        function getDestinationCoords(cityName) {
            const coords = {
                'London': [51.5074, -0.1278],
                'Paris': [48.8566, 2.3522],
                'New York City': [40.7128, -74.0060],
                'Tokyo': [35.6762, 139.6503],
                'Sydney': [-33.8688, 151.2093],
                'Dubai': [25.2048, 55.2708],
                'Singapore': [1.3521, 103.8198],
                'Barcelona': [41.3851, 2.1734],
                'Rome': [41.9028, 12.4964],
                'Amsterdam': [52.3676, 4.9041]
            };
            return coords[cityName];
        }

        // Get airport coordinates by IATA code
        function getAirportCoords(iataCode) {
            const airports = {
                // Major European airports
                'MAD': [40.4983, -3.5676], // Madrid
                'BCN': [41.2974, 2.0833],  // Barcelona
                'AGP': [36.6749, -4.4991], // M√°laga
                'XRY': [36.7446, -6.0601], // Jerez
                'SVQ': [37.4180, -5.8931], // Seville
                'LHR': [51.4700, -0.4543], // London Heathrow
                'CDG': [49.0097, 2.5479],  // Paris CDG
                'AMS': [52.3105, 4.7683],  // Amsterdam
                'FRA': [50.0379, 8.5622],  // Frankfurt
                'MUC': [48.3537, 11.7750], // Munich
                'FCO': [41.8003, 12.2389], // Rome
                'VCE': [45.5053, 12.3519], // Venice
                'MXP': [45.6301, 8.7231],  // Milan
                'LIS': [38.7742, -9.1342], // Lisbon
                'OPO': [41.2481, -8.6814], // Porto
                'DUB': [53.4213, -6.2701], // Dublin
                'BRU': [50.9010, 4.4856],  // Brussels
                'VIE': [48.1103, 16.5697], // Vienna
                'ZRH': [47.4582, 8.5554],  // Zurich
                'CPH': [55.6180, 12.6508], // Copenhagen
                'OSL': [60.1939, 11.1004], // Oslo
                'ARN': [59.6519, 17.9186], // Stockholm
                'ATH': [37.9364, 23.9445], // Athens
                'IST': [41.2753, 28.7519], // Istanbul
                // Other major airports
                'JFK': [40.6413, -73.7781], // New York JFK
                'LAX': [33.9416, -118.4085], // Los Angeles
                'ORD': [41.9742, -87.9073], // Chicago
                'DXB': [25.2532, 55.3657],  // Dubai
                'SIN': [1.3644, 103.9915],  // Singapore
                'HND': [35.5494, 139.7798], // Tokyo Haneda
                'NRT': [35.7720, 140.3929], // Tokyo Narita
                'SYD': [-33.9399, 151.1753], // Sydney
                'HKG': [22.3080, 113.9185], // Hong Kong
                'ICN': [37.4602, 126.4407]  // Seoul
            };
            return airports[iataCode.toUpperCase()] || null;
        }

        // ===================================
        // EXISTING FUNCTIONS (UPDATED)
        // ===================================

        // Resolve user's nearest airport
        async function resolveAirport() {
            const cityInput = document.getElementById('cityInput');
            const countryInput = document.getElementById('countryInput');
            const resultDiv = document.getElementById('airportResult');
            const codeEl = document.getElementById('airportCode');
            const nameEl = document.getElementById('airportName');
            const locationEl = document.getElementById('airportLocation');

            const city = cityInput.value.trim();
            const country = countryInput.value.trim();

            if (!city || !country) {
                alert('Please enter both city and country');
                return;
            }

            // Hide previous result
            resultDiv.classList.remove('show');

            // Show loading state
            cityInput.disabled = true;
            countryInput.disabled = true;

            try {
                // Ensure we have a valid token
                const token = getAuthToken();
                if (!token) {
                    throw new Error('Not authenticated. Please refresh the page and log in again.');
                }

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };

                console.log('Sending request to resolve-airport with token:', token.substring(0, 20) + '...');

                const response = await fetch(`${API_ENDPOINT}/resolve-airport`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ city, country })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Display result
                codeEl.textContent = data.airport_code;
                nameEl.textContent = data.airport_name;
                locationEl.textContent = `Nearest airport for ${data.city}, ${data.country}`;
                resultDiv.classList.add('show');

                // Store airport code, alternatives, and show recommendations section
                userDepartureAirport = data.airport_code;
                userAirportAlternatives = data.alternatives || [];
                console.log('Stored alternatives:', userAirportAlternatives);
                document.getElementById('recommendationsSection').classList.add('show');

                // Clear all old markers and paths from map first
                console.log('Clearing old map markers before adding new departure marker');
                if (departureMarker) {
                    map.removeLayer(departureMarker);
                    departureMarker = null;
                }
                destinationMarkers.forEach(marker => map.removeLayer(marker));
                flightPaths.forEach(path => map.removeLayer(path));
                destinationMarkers = [];
                flightPaths = [];

                // Add departure marker to map using coordinates from API response
                if (data.latitude && data.longitude) {
                    addDepartureMarker(data.latitude, data.longitude, data.airport_code, data.airport_name, data.city, data.country);
                } else {
                    console.warn(`No coordinates returned for airport ${data.airport_code}`);
                }

            } catch (error) {
                console.error('Error resolving airport:', error);
                alert(`Error: ${error.message}`);
            } finally {
                cityInput.disabled = false;
                countryInput.disabled = false;
            }
        }

        function getCurrentWeights() {
            const weatherWeight = parseInt(document.getElementById('weatherWeight').value) / 100;
            const qolWeight = parseInt(document.getElementById('qolWeight').value) / 100;
            const flightWeight = parseInt(document.getElementById('flightWeight').value) / 100;

            return {
                weather: weatherWeight,
                qol: qolWeight,
                flight: flightWeight
            };
        }

        function updateWeights(changedSlider) {
            const weatherSlider = document.getElementById('weatherWeight');
            const qolSlider = document.getElementById('qolWeight');
            const flightSlider = document.getElementById('flightWeight');

            const weatherValue = document.getElementById('weatherWeightValue');
            const qolValue = document.getElementById('qolWeightValue');
            const flightValue = document.getElementById('flightWeightValue');
            const warning = document.getElementById('weightWarning');

            const weather = parseInt(weatherSlider.value);
            const qol = parseInt(qolSlider.value);
            const flight = parseInt(flightSlider.value);

            weatherValue.textContent = `${weather}%`;
            qolValue.textContent = `${qol}%`;
            flightValue.textContent = `${flight}%`;

            const total = weather + qol + flight;

            if (total !== 100) {
                warning.style.display = 'block';
                warning.textContent = `‚ö†Ô∏è Weights total ${total}% (must be 100%)`;
            } else {
                warning.style.display = 'none';
            }
        }

        // Get travel recommendations
        async function getRecommendations() {
            if (!userDepartureAirport) {
                alert('Please find your nearest airport first!');
                return;
            }

            const weatherPct = parseInt(document.getElementById('weatherWeight').value);
            const qolPct = parseInt(document.getElementById('qolWeight').value);
            const flightPct = parseInt(document.getElementById('flightWeight').value);
            const total = weatherPct + qolPct + flightPct;

            if (total !== 100) {
                alert(`Weights must total 100% (currently ${total}%). Please adjust the sliders.`);
                return;
            }

            const contentEl = document.getElementById('recommendationsContent');
            const btn = document.getElementById('getRecommendationsBtn');

            // Show loading
            btn.disabled = true;
            btn.textContent = 'Calculating... (10-15 seconds)';
            contentEl.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p style="color: #666; margin-top: 16px;">
                        Searching real-time flight prices for all 12 destinations in parallel...<br>
                        This usually takes 10-15 seconds. Please wait!
                    </p>
                </div>
            `;

            try {
                // Ensure we have a valid token
                const token = getAuthToken();
                if (!token) {
                    throw new Error('Not authenticated. Please refresh the page and log in again.');
                }

                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };

                console.log('Sending request to travel-recommendations with token:', token.substring(0, 20) + '...');

                const weights = getCurrentWeights();

                const response = await fetch(`${API_ENDPOINT}/travel-recommendations`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        departure_airport: userDepartureAirport,
                        alternatives: userAirportAlternatives,
                        weights: weights
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Display recommendations
                displayRecommendations(data.recommendations, data.weights);

                // Add recommendation markers to map
                addRecommendationMarkers(data.recommendations);

            } catch (error) {
                console.error('Error getting recommendations:', error);
                contentEl.innerHTML = `
                    <div style="background: #fee; padding: 20px; border-radius: 8px; color: #c33;">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Get My Top 3 Recommendations';
            }
        }

        // Display travel recommendations
        function displayRecommendations(recommendations, weights) {
            const contentEl = document.getElementById('recommendationsContent');

            if (!recommendations || recommendations.length === 0) {
                contentEl.innerHTML = '<p style="color: #666;">No recommendations found.</p>';
                return;
            }

            let html = '<div style="margin-bottom: 16px; color: #666; font-size: 0.9rem;">';
            html += `<strong>Scoring Weights:</strong> Weather ${weights.weather * 100}%, Quality of Life ${weights.qol * 100}%, Flight Price ${weights.flight * 100}%`;
            html += '</div>';

            recommendations.forEach((rec, index) => {
                const rank = index + 1;
                html += `
                    <div class="recommendation-card">
                        <div class="recommendation-rank">#${rank}</div>
                        <div class="recommendation-header">
                            <div>
                                <div class="recommendation-city">${rec.city}</div>
                                <div class="recommendation-country">${rec.country} (${rec.iata_code})</div>
                            </div>
                            <div class="recommendation-score">
                                <div class="score-total">${rec.scores.total_score.toFixed(3)}</div>
                                <div class="score-label">Total Score</div>
                            </div>
                        </div>

                        <div class="score-breakdown">
                            <div class="score-item">
                                <div class="score-item-label">Weather Score</div>
                                <div class="score-item-value">${rec.scores.weather_score.toFixed(3)}</div>
                            </div>
                            <div class="score-item">
                                <div class="score-item-label">Quality of Life</div>
                                <div class="score-item-value">${rec.scores.qol_score.toFixed(3)}</div>
                            </div>
                            <div class="score-item">
                                <div class="score-item-label">Flight Price</div>
                                <div class="score-item-value">${rec.scores.flight_score.toFixed(3)}</div>
                            </div>
                        </div>

                        <div class="recommendation-details">
                            <div class="detail-item">
                                <div class="detail-value">${rec.details.avg_temperature}¬∞C</div>
                                <div class="detail-label">3-Day Avg Temp</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${rec.details.flight_price ? '‚Ç¨' + rec.details.flight_price.toFixed(2) : 'N/A'}</div>
                                <div class="detail-label">Round-Trip Price</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${rec.details.quality_of_life.michelin_restaurants}</div>
                                <div class="detail-label">Michelin Restaurants</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            contentEl.innerHTML = html;
        }

        // Fetch destinations from API
        async function fetchDestinations() {
            const statusEl = document.getElementById('status');
            const fetchBtn = document.getElementById('fetchBtn');
            const gridEl = document.getElementById('destinationsGrid');

            // Update UI
            statusEl.textContent = 'Loading destinations...';
            statusEl.className = 'status loading';
            fetchBtn.disabled = true;

            try {
                const response = await fetch(`${API_ENDPOINT}/weather`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Display results
                displayDestinations(data);

                // Update status
                const successCount = data.results.filter(r => r.status === 'success').length;
                const totalCount = data.results.length;

                if (successCount === 0) {
                    statusEl.textContent = `Loaded ${totalCount} destinations (Weather API keys not configured yet)`;
                    statusEl.className = 'status';
                } else {
                    statusEl.textContent = `Successfully loaded ${successCount}/${totalCount} destinations with weather data`;
                    statusEl.className = 'status success';
                }

            } catch (error) {
                console.error('Error fetching destinations:', error);
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'status error';
                gridEl.innerHTML = '<p style="color: white; text-align: center;">Failed to load destinations. Check console for details.</p>';
            } finally {
                fetchBtn.disabled = false;
            }
        }

        // Display destinations in grid
        function displayDestinations(data) {
            const gridEl = document.getElementById('destinationsGrid');
            gridEl.innerHTML = '';

            if (!data.results || data.results.length === 0) {
                gridEl.innerHTML = '<p style="color: white; text-align: center;">No destinations found</p>';
                return;
            }

            // Sort by city name
            const sortedResults = data.results.sort((a, b) => a.city.localeCompare(b.city));

            sortedResults.forEach(result => {
                const card = createDestinationCard(result);
                gridEl.appendChild(card);
            });
        }

        // Create destination card element
        function createDestinationCard(destination) {
            const card = document.createElement('div');
            card.className = 'destination-card';

            // Note: Since we're getting results from Lambda, we need to fetch full destination data
            // For now, we'll use the hardcoded data structure
            const destinationData = getDestinationData(destination.city);

            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="city-name">${destination.city}</div>
                        <div class="country">${destinationData.country}</div>
                    </div>
                    <div class="iata-code">${destinationData.iata_code}</div>
                </div>

                ${destination.status === 'success' && destination.weather ? `
                    <div class="weather-section">
                        <div class="weather-info">
                            <div class="temperature">${Math.round(destination.weather.avg_temperature)}¬∞C</div>
                            <div class="weather-description">${destination.weather.description}</div>
                        </div>
                        <div class="weather-details">
                            <div>3-Day Average</div>
                            <div>Min: ${Math.round(destination.weather.min_temperature)}¬∞C / Max: ${Math.round(destination.weather.max_temperature)}¬∞C</div>
                        </div>
                    </div>
                ` : `
                    <div class="weather-section">
                        <div class="no-weather">Weather data unavailable (API key needed)</div>
                    </div>
                `}

                <div class="qol-section">
                    <div class="qol-title">Quality of Life Metrics</div>
                    <div class="qol-grid">
                        <div class="qol-item">
                            <span>Beer Price</span>
                            <span class="qol-value">‚Ç¨${destinationData.qol.beer_price_eur}</span>
                        </div>
                        <div class="qol-item">
                            <span>Michelin Restaurants</span>
                            <span class="qol-value">${destinationData.qol.michelin_restaurants}</span>
                        </div>
                        <div class="qol-item">
                            <span>Food Quality</span>
                            <span class="qol-value">${destinationData.qol.food_quality_score}/10</span>
                        </div>
                        <div class="qol-item">
                            <span>Walkability</span>
                            <span class="qol-value">${destinationData.qol.walkability_score}/10</span>
                        </div>
                        <div class="qol-item">
                            <span>Public Transport</span>
                            <span class="qol-value">${destinationData.qol.public_transport_score}/10</span>
                        </div>
                        <div class="qol-item">
                            <span>Safety</span>
                            <span class="qol-value">${destinationData.qol.safety_score}/10</span>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // Hardcoded destination data (matches the S3 data)
        function getDestinationData(cityName) {
            const destinations = {
                'London': {
                    country: 'United Kingdom',
                    iata_code: 'LHR',
                    qol: { beer_price_eur: 6.5, michelin_restaurants: 67, food_quality_score: 8.7, walkability_score: 8.2, public_transport_score: 9.1, safety_score: 7.8 }
                },
                'Paris': {
                    country: 'France',
                    iata_code: 'CDG',
                    qol: { beer_price_eur: 7.0, michelin_restaurants: 119, food_quality_score: 9.5, walkability_score: 8.8, public_transport_score: 9.0, safety_score: 7.2 }
                },
                'New York City': {
                    country: 'USA',
                    iata_code: 'JFK',
                    qol: { beer_price_eur: 8.0, michelin_restaurants: 76, food_quality_score: 9.2, walkability_score: 8.5, public_transport_score: 8.7, safety_score: 7.0 }
                },
                'Tokyo': {
                    country: 'Japan',
                    iata_code: 'HND',
                    qol: { beer_price_eur: 5.5, michelin_restaurants: 226, food_quality_score: 9.8, walkability_score: 9.0, public_transport_score: 9.8, safety_score: 9.5 }
                },
                'Sydney': {
                    country: 'Australia',
                    iata_code: 'SYD',
                    qol: { beer_price_eur: 9.0, michelin_restaurants: 22, food_quality_score: 8.5, walkability_score: 7.8, public_transport_score: 8.0, safety_score: 8.8 }
                },
                'Dubai': {
                    country: 'UAE',
                    iata_code: 'DXB',
                    qol: { beer_price_eur: 12.0, michelin_restaurants: 11, food_quality_score: 8.0, walkability_score: 6.5, public_transport_score: 7.5, safety_score: 9.0 }
                },
                'Singapore': {
                    country: 'Singapore',
                    iata_code: 'SIN',
                    qol: { beer_price_eur: 10.0, michelin_restaurants: 49, food_quality_score: 9.3, walkability_score: 8.7, public_transport_score: 9.5, safety_score: 9.7 }
                },
                'Barcelona': {
                    country: 'Spain',
                    iata_code: 'BCN',
                    qol: { beer_price_eur: 4.5, michelin_restaurants: 31, food_quality_score: 9.0, walkability_score: 9.2, public_transport_score: 8.5, safety_score: 7.5 }
                },
                'Rome': {
                    country: 'Italy',
                    iata_code: 'FCO',
                    qol: { beer_price_eur: 5.0, michelin_restaurants: 22, food_quality_score: 9.4, walkability_score: 8.0, public_transport_score: 7.0, safety_score: 7.3 }
                },
                'Amsterdam': {
                    country: 'Netherlands',
                    iata_code: 'AMS',
                    qol: { beer_price_eur: 5.5, michelin_restaurants: 19, food_quality_score: 8.3, walkability_score: 9.5, public_transport_score: 8.8, safety_score: 8.5 }
                },
                'Lisbon': {
                    country: 'Portugal',
                    iata_code: 'LIS',
                    qol: { beer_price_eur: 3.5, michelin_restaurants: 8, food_quality_score: 8.8, walkability_score: 8.9, public_transport_score: 7.8, safety_score: 8.2 }
                },
                'Vienna': {
                    country: 'Austria',
                    iata_code: 'VIE',
                    qol: { beer_price_eur: 4.5, michelin_restaurants: 17, food_quality_score: 9.1, walkability_score: 9.3, public_transport_score: 9.6, safety_score: 9.2 }
                }
            };

            return destinations[cityName] || {
                country: 'Unknown',
                iata_code: 'N/A',
                qol: { beer_price_eur: 0, michelin_restaurants: 0, food_quality_score: 0, walkability_score: 0, public_transport_score: 0, safety_score: 0 }
            };
        }

        // Auto-load on page load
        window.addEventListener('load', () => {
            fetchDestinations();
        });
    </script>
</body>
</html>
